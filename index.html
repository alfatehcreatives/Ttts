<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memoirs - Your Digital Legacy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #0a0a0c;
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                              radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%);
            min-height: 100vh;
            color: #1a1a1a;
            overflow-x: hidden;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
        }
        .sidebar-active { background: #1a1a1a; color: white !important; }
        .dark-card { background: #1a1a1a; color: white; border-radius: 24px; }
        .status-pill { background: rgba(255, 255, 255, 0.9); border-radius: 12px; padding: 8px; color: #1a1a1a; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .search-container { transition: all 0.3s ease; width: 40px; }
        .search-container.active { width: 200px; background: rgba(255,255,255,0.2); }
        #lightbox { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
        @media (max-width: 767px) {
            .mobile-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-top: 1px solid rgba(0,0,0,0.05); z-index: 50; display: flex; justify-content: space-around; padding: 12px 10px 24px 10px; }
            .nav-btn { flex-direction: column; font-size: 10px !important; gap: 4px !important; padding: 8px !important; border-radius: 12px !important; }
            main { padding-bottom: 100px; }
        }
    </style>
</head>
<body class="p-3 md:p-8">
    <div class="max-w-7xl mx-auto flex flex-col md:flex-row gap-4 md:gap-6 h-full md:h-[90vh]">
        <aside class="hidden md:flex w-64 glass-panel p-6 flex-col justify-between shrink-0">
            <div>
                <div class="flex items-center gap-3 mb-10 px-2">
                    <div class="w-8 h-8 bg-black rounded-lg flex items-center justify-center"><i class="ph ph-feather text-white text-lg"></i></div>
                    <h1 class="font-bold text-xl tracking-tight">Memoirs</h1>
                </div>
                <nav class="space-y-2">
                    <button onclick="showTab('dashboard')" id="nav-dashboard" class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm font-medium sidebar-active rounded-xl"><i class="ph ph-squares-four text-xl"></i> Dashboard</button>
                    <button onclick="showTab('memories')" id="nav-memories" class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm font-medium hover:bg-white/50 rounded-xl transition"><i class="ph ph-book-open text-xl"></i> Memories</button>
                    <button onclick="showTab('dates')" id="nav-dates" class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm font-medium hover:bg-white/50 rounded-xl transition"><i class="ph ph-calendar text-xl"></i> Imp. Dates</button>
                    <button onclick="showTab('media')" id="nav-media" class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm font-medium hover:bg-white/50 rounded-xl transition"><i class="ph ph-image text-xl"></i> Media</button>
                </nav>
            </div>
        </aside>

        <div class="mobile-nav md:hidden">
            <button onclick="showTab('dashboard')" id="m-nav-dashboard" class="nav-btn flex items-center text-gray-500 sidebar-active"><i class="ph ph-squares-four"></i> <span>Home</span></button>
            <button onclick="showTab('memories')" id="m-nav-memories" class="nav-btn flex items-center text-gray-500"><i class="ph ph-book-open"></i> <span>Vault</span></button>
            <button onclick="showTab('dates')" id="m-nav-dates" class="nav-btn flex items-center text-gray-500"><i class="ph ph-calendar"></i> <span>Dates</span></button>
            <button onclick="showTab('media')" id="m-nav-media" class="nav-btn flex items-center text-gray-500"><i class="ph ph-image"></i> <span>Media</span></button>
        </div>

        <main class="flex-1 flex flex-col gap-6 overflow-hidden">
            <header class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl md:text-2xl font-bold text-white/90">Hi, Memory Keeper!</h2>
                    <p id="sync-status" class="text-white/60 text-xs md:text-sm italic">Connecting...</p>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="openModal()" class="bg-white text-black px-5 py-2.5 rounded-full text-sm font-bold flex items-center gap-2 hover:bg-gray-200 transition">
                        <i class="ph ph-plus"></i> <span class="hidden md:inline">Capture</span>
                    </button>
                    <div id="searchBox" class="search-container flex items-center overflow-hidden h-10 rounded-full bg-white/10 border border-white/20 text-white transition-all">
                        <button onclick="toggleSearch()" class="w-10 h-10 flex-shrink-0 flex items-center justify-center"><i class="ph ph-magnifying-glass"></i></button>
                        <input type="text" id="searchInput" placeholder="Search..." onkeyup="handleSearch(this.value)" class="bg-transparent border-none outline-none text-xs w-full pr-4 opacity-0 transition-opacity">
                    </div>
                </div>
            </header>

            <div id="tab-dashboard" class="tab-content active h-full overflow-y-auto">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="dark-card p-6">
                        <span class="text-xs text-gray-400 uppercase tracking-widest">Vault Status</span>
                        <h3 class="text-4xl font-bold mt-2" id="stat-total">0</h3>
                        <div class="flex gap-2 mt-6">
                            <div class="status-pill flex-1 text-center"><p class="text-[9px] text-gray-500">VAULT</p><p class="font-bold text-sm" id="count-vault">0</p></div>
                            <div class="status-pill flex-1 text-center"><p class="text-[9px] text-gray-500">MEDIA</p><p class="font-bold text-sm" id="count-media">0</p></div>
                        </div>
                    </div>
                    <div class="glass-panel p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-bold text-sm">Milestones</h4>
                            <button onclick="addMilestone()" class="text-xs text-black/40 hover:text-black"><i class="ph ph-plus"></i></button>
                        </div>
                        <div class="space-y-3" id="mini-milestones"></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-panel p-6">
                        <h4 class="font-bold text-sm mb-4">Important Dates</h4>
                        <div id="dash-dates" class="space-y-3"></div>
                    </div>
                    <div class="glass-panel p-6">
                        <h4 class="font-bold text-sm mb-4">Recent Media</h4>
                        <div id="dash-media" class="grid grid-cols-3 gap-2"></div>
                    </div>
                </div>
            </div>

            <div id="tab-memories" class="tab-content h-full overflow-y-auto">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="memories-list"></div>
            </div>
            <div id="tab-dates" class="tab-content h-full overflow-y-auto">
                <div class="glass-panel p-6" id="full-dates-list"></div>
            </div>
            <div id="tab-media" class="tab-content h-full overflow-y-auto">
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4" id="media-gallery"></div>
            </div>
        </main>
    </div>

    <div id="lightbox" onclick="this.style.display='none'"><img id="lightboxImg" class="max-w-full max-h-[85vh] rounded-xl object-contain"></div>

    <div id="captureModal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[100] hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-lg p-6 md:p-8">
            <h3 class="text-xl font-bold mb-6">New Capture</h3>
            <form id="memoryForm" class="space-y-4">
                <input type="text" id="m-title" placeholder="Title" required class="w-full bg-white/50 border border-black/10 px-4 py-3 rounded-xl outline-none">
                <input type="text" id="m-content" placeholder="URL or Text" class="w-full bg-white/50 border border-black/10 px-4 py-3 rounded-xl outline-none">
                <select id="m-type" class="w-full bg-white/50 border border-black/10 px-4 py-3 rounded-xl">
                    <option value="memories">Memories</option>
                    <option value="dates">Dates</option>
                    <option value="media">Media</option>
                </select>
                <input type="date" id="m-date" class="w-full bg-white/50 border border-black/10 px-4 py-3 rounded-xl">
                <div class="flex gap-3">
                    <button type="button" onclick="closeModal()" class="flex-1 font-bold">Cancel</button>
                    <button type="submit" class="flex-1 bg-black text-white font-bold py-3 rounded-xl">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, updateDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'memoirs-app';

        let user = null;
        let appData = { memories: [], dates: [], media: [], milestones: [] };
        let searchQuery = "";

        // UI Logic
        window.showTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('sidebar-active'));
            document.getElementById(`tab-${id}`).classList.add('active');
            document.getElementById(`nav-${id}`)?.classList.add('sidebar-active');
            document.getElementById(`m-nav-${id}`)?.classList.add('sidebar-active');
        };
        window.openModal = () => document.getElementById('captureModal').classList.remove('hidden');
        window.closeModal = () => document.getElementById('captureModal').classList.add('hidden');
        window.toggleSearch = () => {
            const container = document.getElementById('searchBox');
            container.classList.toggle('active');
            const input = document.getElementById('searchInput');
            input.style.opacity = container.classList.contains('active') ? "1" : "0";
            if(container.classList.contains('active')) input.focus();
        };
        window.handleSearch = (val) => { searchQuery = val.toLowerCase(); render(); };
        window.openLightbox = (url) => {
            document.getElementById('lightboxImg').src = url;
            document.getElementById('lightbox').style.display = 'flex';
        };

        // Auth
        (async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                document.getElementById('sync-status').innerText = "Auth Error";
            }
        })();

        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                document.getElementById('sync-status').innerText = "Live Vault Synced";
                startListeners();
            }
        });

        function startListeners() {
            ['memories', 'dates', 'media', 'milestones'].forEach(colName => {
                const q = query(collection(db, 'artifacts', appId, 'users', user.uid, colName));
                onSnapshot(q, (snapshot) => {
                    appData[colName] = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    render();
                });
            });
        }

        window.deleteItem = async (col, id) => {
            if (!user) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, col, id));
        };

        window.addMilestone = async () => {
            const text = prompt("Milestone:");
            if (text && user) await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'milestones'), { text, completed: false });
        };

        window.toggleMilestone = async (id, current) => {
            await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'milestones', id), { completed: !current });
        };

        document.getElementById('memoryForm').onsubmit = async (e) => {
            e.preventDefault();
            if (!user) return;
            const type = document.getElementById('m-type').value;
            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, type), {
                title: document.getElementById('m-title').value,
                content: document.getElementById('m-content').value,
                url: document.getElementById('m-content').value,
                date: document.getElementById('m-date').value || new Date().toISOString().split('T')[0],
                timestamp: Date.now()
            });
            window.closeModal();
            e.target.reset();
        };

        function render() {
            const filter = (arr) => arr.filter(i => (i.title || i.text || "").toLowerCase().includes(searchQuery));
            
            document.getElementById('stat-total').innerText = appData.memories.length + appData.media.length;
            document.getElementById('count-vault').innerText = appData.memories.length;
            document.getElementById('count-media').innerText = appData.media.length;

            document.getElementById('mini-milestones').innerHTML = filter(appData.milestones).map(m => `
                <div class="flex items-center gap-3 text-sm cursor-pointer" onclick="toggleMilestone('${m.id}', ${m.completed})">
                    <i class="${m.completed ? 'ph-fill ph-check-circle' : 'ph ph-circle'}"></i>
                    <span class="${m.completed ? 'line-through opacity-40' : ''}">${m.text}</span>
                </div>
            `).join('');

            document.getElementById('memories-list').innerHTML = filter(appData.memories).map(m => `
                <div class="glass-panel p-4 relative group">
                    <button onclick="deleteItem('memories', '${m.id}')" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition">×</button>
                    <h5 class="font-bold text-black truncate">${m.title}</h5>
                    <p class="text-xs text-gray-500 mt-2 line-clamp-2">${m.content}</p>
                </div>
            `).join('');

            document.getElementById('media-gallery').innerHTML = filter(appData.media).map(m => `
                <div class="aspect-square rounded-xl overflow-hidden relative group">
                    <img onclick="openLightbox('${m.url}')" src="${m.url}" class="w-full h-full object-cover cursor-zoom-in">
                    <button onclick="deleteItem('media', '${m.id}')" class="absolute top-1 right-1 bg-black/50 text-white p-1 rounded opacity-0 group-hover:opacity-100">×</button>
                </div>
            `).join('');

            document.getElementById('dash-dates').innerHTML = filter(appData.dates).slice(0, 3).map(d => `
                <div class="p-3 bg-white/40 rounded-xl text-sm font-medium">${d.title} - ${d.date}</div>
            `).join('');

            document.getElementById('dash-media').innerHTML = filter(appData.media).slice(0, 3).map(m => `
                <img src="${m.url}" class="aspect-square rounded-lg object-cover">
            `).join('');

            document.getElementById('full-dates-list').innerHTML = filter(appData.dates).map(d => `
                <div class="flex justify-between items-center py-3 border-b border-black/5">
                    <span>${d.title}</span><span class="text-gray-400">${d.date}</span>
                </div>
            `).join('');
        }
    </script>
</body>
</html>


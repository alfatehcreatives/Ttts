<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memoirs - Your Digital Legacy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Using Compat SDKs to avoid "Script error" in restricted environments -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #0a0a0c;
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                              radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%);
            min-height: 100vh;
            color: #1a1a1a;
            overflow-x: hidden;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
        }
        .sidebar-active { background: #1a1a1a; color: white !important; }
        .dark-card { background: #1a1a1a; color: white; border-radius: 24px; }
        .status-pill { background: rgba(255, 255, 255, 0.9); border-radius: 12px; padding: 8px; color: #1a1a1a; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        @media (max-width: 767px) {
            .mobile-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); z-index: 50; display: flex; justify-content: space-around; padding: 12px 10px 24px 10px; }
            .nav-btn { flex-direction: column; font-size: 10px !important; gap: 4px !important; padding: 8px !important; border-radius: 12px !important; }
            main { padding-bottom: 100px; }
        }
        .search-container { transition: all 0.3s ease; width: 40px; }
        .search-container.active { width: 200px; background: rgba(255,255,255,0.2); }
        #lightbox { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
    </style>
</head>
<body class="p-3 md:p-8">

    <div class="max-w-7xl mx-auto flex flex-col md:flex-row gap-4 md:gap-6 h-full md:h-[90vh]">
        <aside class="hidden md:flex w-64 glass-panel p-6 flex-col justify-between shrink-0">
            <div>
                <div class="flex items-center gap-3 mb-10 px-2">
                    <div class="w-8 h-8 bg-black rounded-lg flex items-center justify-center">
                        <i class="ph ph-feather text-white text-lg"></i>
                    </div>
                    <h1 class="font-bold text-xl tracking-tight text-black">Memoirs</h1>
                </div>
                <nav class="space-y-2">
                    <button onclick="showTab('dashboard')" id="nav-dashboard" class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm font-medium sidebar-active rounded-xl transition">
                        <i class="ph ph-squares-four text-xl"></i> Dashboard
                    </button>
                    <button onclick="showTab('memories')" id="nav-memories" class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm font-medium hover:bg-white/50 rounded-xl transition">
                        <i class="ph ph-book-open text-xl"></i> Memories
                    </button>
                    <button onclick="showTab('dates')" id="nav-dates" class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm font-medium hover:bg-white/50 rounded-xl transition">
                        <i class="ph ph-calendar text-xl"></i> Imp. Dates
                    </button>
                    <button onclick="showTab('media')" id="nav-media" class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm font-medium hover:bg-white/50 rounded-xl transition">
                        <i class="ph ph-image text-xl"></i> Media
                    </button>
                </nav>
            </div>
            <p class="text-[10px] text-gray-400 px-4" id="sync-status">Initializing...</p>
        </aside>

        <div class="mobile-nav md:hidden">
            <button onclick="showTab('dashboard')" id="m-nav-dashboard" class="nav-btn flex items-center text-gray-500 sidebar-active">
                <i class="ph ph-squares-four"></i> <span>Home</span>
            </button>
            <button onclick="showTab('memories')" id="m-nav-memories" class="nav-btn flex items-center text-gray-500">
                <i class="ph ph-book-open"></i> <span>Vault</span>
            </button>
            <button onclick="showTab('dates')" id="m-nav-dates" class="nav-btn flex items-center text-gray-500">
                <i class="ph ph-calendar"></i> <span>Dates</span>
            </button>
            <button onclick="showTab('media')" id="m-nav-media" class="nav-btn flex items-center text-gray-500">
                <i class="ph ph-image"></i> <span>Media</span>
            </button>
        </div>

        <main class="flex-1 flex flex-col gap-6 overflow-x-hidden md:overflow-hidden">
            <header class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl md:text-2xl font-bold text-white/90">Hi, Memory Keeper!</h2>
                    <p class="text-white/60 text-xs md:text-sm">Your life is safely stored.</p>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="openModal()" class="bg-white text-black p-2 md:px-5 md:py-2.5 rounded-full text-sm font-bold flex items-center gap-2 hover:bg-gray-200 transition">
                        <i class="ph ph-plus"></i> <span class="hidden md:inline">Capture</span>
                    </button>
                    <div id="searchBox" class="search-container flex items-center overflow-hidden h-10 rounded-full bg-white/10 border border-white/20 text-white">
                        <button onclick="toggleSearch()" class="w-10 h-10 flex-shrink-0 flex items-center justify-center">
                            <i class="ph ph-magnifying-glass"></i>
                        </button>
                        <input type="text" id="searchInput" placeholder="Search..." onkeyup="handleSearch(this.value)" class="bg-transparent border-none outline-none text-xs w-full pr-4 opacity-0 transition-opacity">
                    </div>
                </div>
            </header>

            <div id="tab-dashboard" class="tab-content active h-full overflow-y-auto md:pr-2">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="dark-card p-6">
                        <div class="flex justify-between items-start">
                            <span class="text-xs text-gray-400 uppercase tracking-widest">Vault Status</span>
                            <i class="ph ph-cloud-arrow-up text-blue-500 text-xl"></i>
                        </div>
                        <div class="mt-4">
                            <h3 class="text-4xl font-bold" id="stat-memories">0</h3>
                            <p class="text-[10px] text-gray-400 mt-1 uppercase">Cloud Protected Items</p>
                        </div>
                        <div class="flex gap-2 mt-6">
                            <div class="status-pill flex-1 text-center">
                                <p class="text-[9px] text-gray-500">VAULT</p>
                                <p class="font-bold text-sm" id="count-vault">0</p>
                            </div>
                            <div class="status-pill flex-1 text-center">
                                <p class="text-[9px] text-gray-500">MEDIA</p>
                                <p class="font-bold text-sm" id="count-media">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="glass-panel p-6 flex flex-col h-48 lg:h-auto">
                        <h4 class="font-bold text-sm mb-4">Activity Pulse</h4>
                        <div class="flex-1 flex items-end gap-2 px-2">
                            <div class="flex-1 bg-black/5 rounded-t-lg h-[40%]"></div>
                            <div class="flex-1 bg-black/5 rounded-t-lg h-[60%]"></div>
                            <div class="flex-1 bg-black/5 rounded-t-lg h-[30%]"></div>
                            <div class="flex-1 bg-black/5 rounded-t-lg h-[80%]"></div>
                            <div class="flex-1 bg-black rounded-t-lg h-[95%]"></div>
                        </div>
                    </div>
                    <div class="glass-panel p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-bold text-sm">Milestones</h4>
                            <button onclick="addMilestone()" class="text-xs text-black/40 hover:text-black"><i class="ph ph-plus"></i></button>
                        </div>
                        <div class="space-y-3" id="mini-milestones"></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-panel p-6">
                        <h4 class="font-bold text-sm mb-4">Upcoming Dates</h4>
                        <div class="space-y-3" id="dash-dates"></div>
                    </div>
                    <div class="glass-panel p-6">
                        <h4 class="font-bold text-sm mb-4">Latest Media</h4>
                        <div class="grid grid-cols-3 gap-2" id="dash-media"></div>
                    </div>
                </div>
            </div>

            <div id="tab-memories" class="tab-content h-full overflow-y-auto">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="memories-list"></div>
            </div>

            <div id="tab-dates" class="tab-content h-full overflow-y-auto">
                <div class="glass-panel p-8">
                    <h3 class="text-xl font-bold mb-6">Upcoming Dates</h3>
                    <div class="space-y-4" id="full-dates-list"></div>
                </div>
            </div>

            <div id="tab-media" class="tab-content h-full overflow-y-auto">
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4" id="media-gallery"></div>
            </div>
        </main>
    </div>

    <div id="lightbox" onclick="closeLightbox()">
        <button class="absolute top-6 right-6 text-white text-3xl"><i class="ph ph-x"></i></button>
        <img id="lightboxImg" src="" class="max-w-full max-h-[85vh] rounded-xl shadow-2xl object-contain">
    </div>

    <div id="captureModal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[100] hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-lg p-6 md:p-8 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">New Memory</h3>
                <button onclick="closeModal()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-black/5"><i class="ph ph-x"></i></button>
            </div>
            <form id="memoryForm" class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Title</label>
                    <input type="text" id="m-title" required class="w-full bg-white/50 border border-black/10 px-4 py-3 rounded-xl focus:ring-2 focus:ring-black outline-none">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Link / Description</label>
                    <input type="text" id="m-content" placeholder="https://..." class="w-full bg-white/50 border border-black/10 px-4 py-3 rounded-xl focus:ring-2 focus:ring-black outline-none">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Category</label>
                        <select id="m-type" class="w-full bg-white/50 border border-black/10 px-4 py-3 rounded-xl outline-none">
                            <option value="memories">Memories</option>
                            <option value="dates">Dates</option>
                            <option value="media">Media</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Date</label>
                        <input type="date" id="m-date" class="w-full bg-white/50 border border-black/10 px-4 py-3 rounded-xl outline-none">
                    </div>
                </div>
                <button type="submit" class="w-full bg-black text-white font-bold py-4 rounded-xl mt-4 shadow-lg hover:opacity-90 transition">Sync to Cloud</button>
            </form>
        </div>
    </div>

    <script>
        // Use Global environment variables
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'memoirs-app';
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let appData = { memories: [], dates: [], media: [], milestones: [] };
        let searchQuery = "";
        let userId = null;

        // AUTH & SYNC START
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }
            } catch (err) {
                console.error("Auth error", err);
            }
        };

        auth.onAuthStateChanged((user) => {
            if (user) {
                userId = user.uid;
                setupSync();
            }
        });

        const setupSync = () => {
            const dataRef = db.doc(`artifacts/${appId}/users/${userId}/data/store`);
            dataRef.onSnapshot((docSnap) => {
                if (docSnap.exists) {
                    appData = docSnap.data();
                    renderData();
                    document.getElementById('sync-status').innerText = "Live Synced";
                } else {
                    dataRef.set(appData);
                }
            }, (error) => {
                console.error("Sync Error:", error);
                document.getElementById('sync-status').innerText = "Offline";
            });
        };

        const pushData = async () => {
            if (!userId) return;
            const dataRef = db.doc(`artifacts/${appId}/users/${userId}/data/store`);
            try {
                await dataRef.update(appData);
            } catch (e) {
                // If update fails (doc might not exist), try set
                await dataRef.set(appData);
            }
        };

        // UI ACTIONS
        window.showTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('sidebar-active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.getElementById(`nav-${tabId}`)?.classList.add('sidebar-active');
            document.getElementById(`m-nav-${tabId}`)?.classList.add('sidebar-active');
            renderData();
        };

        window.toggleSearch = () => {
            const container = document.getElementById('searchBox');
            const input = document.getElementById('searchInput');
            container.classList.toggle('active');
            if(container.classList.contains('active')) {
                input.style.opacity = "1";
                input.focus();
            } else {
                input.style.opacity = "0";
                input.value = "";
                window.handleSearch("");
            }
        };

        window.handleSearch = (val) => {
            searchQuery = val.toLowerCase();
            renderData();
        };

        window.openModal = () => document.getElementById('captureModal').classList.remove('hidden');
        window.closeModal = () => document.getElementById('captureModal').classList.add('hidden');
        window.openLightbox = (url) => {
            const lb = document.getElementById('lightbox');
            document.getElementById('lightboxImg').src = url;
            lb.style.display = 'flex';
        };
        window.closeLightbox = () => document.getElementById('lightbox').style.display = 'none';

        document.getElementById('memoryForm').onsubmit = async (e) => {
            e.preventDefault();
            const type = document.getElementById('m-type').value;
            const newItem = {
                id: Date.now(),
                title: document.getElementById('m-title').value,
                content: document.getElementById('m-content').value,
                url: document.getElementById('m-content').value,
                date: document.getElementById('m-date').value || new Date().toISOString().split('T')[0]
            };
            appData[type].push(newItem);
            await pushData();
            window.closeModal();
            e.target.reset();
        };

        window.deleteItem = async (type, id) => {
            appData[type] = appData[type].filter(i => i.id !== id);
            await pushData();
        };

        window.addMilestone = async () => {
            const text = prompt("Enter new milestone:");
            if(text) {
                appData.milestones.push({ id: Date.now(), text, completed: false });
                await pushData();
            }
        };

        window.toggleMilestone = async (id) => {
            const m = appData.milestones.find(item => item.id === id);
            if(m) { m.completed = !m.completed; await pushData(); }
        };

        window.editMilestone = async (id) => {
            const m = appData.milestones.find(item => item.id === id);
            const newText = prompt("Edit milestone:", m.text);
            if(newText) { m.text = newText; await pushData(); }
        };

        function renderData() {
            const filter = (arr) => (arr || []).filter(item => (item.title || item.text || "").toLowerCase().includes(searchQuery));
            
            document.getElementById('stat-memories').innerText = (appData.memories?.length || 0) + (appData.media?.length || 0);
            document.getElementById('count-vault').innerText = appData.memories?.length || 0;
            document.getElementById('count-media').innerText = appData.media?.length || 0;

            document.getElementById('mini-milestones').innerHTML = filter(appData.milestones).map(m => `
                <div class="flex items-center justify-between group">
                    <div class="flex items-center gap-3 text-sm cursor-pointer text-black" onclick="toggleMilestone(${m.id})">
                        <i class="${m.completed ? 'ph-fill ph-check-circle' : 'ph ph-circle text-gray-300'}"></i>
                        <span class="${m.completed ? 'line-through text-gray-400' : ''}">${m.text}</span>
                    </div>
                    <button onclick="editMilestone(${m.id})" class="opacity-0 group-hover:opacity-100 text-gray-400"><i class="ph ph-pencil-simple"></i></button>
                </div>
            `).join('');

            document.getElementById('dash-dates').innerHTML = filter(appData.dates).slice(0, 3).map(d => `
                <div class="flex items-center gap-3 p-3 bg-white/40 rounded-xl text-black">
                    <div class="w-10 h-10 bg-black text-white text-[10px] flex flex-col items-center justify-center rounded-lg">
                        <span class="font-bold">${new Date(d.date).toLocaleString('default', { month: 'short' }).toUpperCase()}</span>
                        <span>${new Date(d.date).getDate()}</span>
                    </div>
                    <span class="text-sm font-medium truncate">${d.title}</span>
                </div>
            `).join('');

            document.getElementById('dash-media').innerHTML = filter(appData.media).slice(0, 3).map(m => `
                <div onclick="openLightbox('${m.url}')" class="aspect-square bg-gray-200 rounded-lg overflow-hidden cursor-pointer">
                    <img src="${m.url}" class="w-full h-full object-cover">
                </div>
            `).join('');

            document.getElementById('memories-list').innerHTML = filter(appData.memories).map(m => `
                <div onclick="window.open('${m.content}', '_blank')" class="glass-panel p-4 cursor-pointer hover:shadow-lg transition group text-black">
                    <div class="flex justify-between mb-3">
                        <i class="ph ph-link text-blue-500 text-lg"></i>
                        <button onclick="event.stopPropagation(); deleteItem('memories', ${m.id})" class="text-gray-300 hover:text-red-500"><i class="ph ph-x"></i></button>
                    </div>
                    <h5 class="font-bold text-sm truncate group-hover:text-blue-600">${m.title}</h5>
                    <p class="text-[10px] text-gray-500 mt-1 truncate">${m.content}</p>
                    <div class="mt-4 pt-3 border-t border-black/5 flex justify-between text-[9px] font-bold text-gray-400">
                        <span>SYNCED</span><span>${m.date}</span>
                    </div>
                </div>
            `).join('');

            document.getElementById('full-dates-list').innerHTML = filter(appData.dates).map(d => `
                <div class="flex items-center justify-between py-3 border-b border-black/5 text-black">
                    <div class="flex gap-4 items-center">
                        <span class="text-xl font-bold">${new Date(d.date).getDate()}</span>
                        <div><p class="font-bold text-sm">${d.title}</p><p class="text-[10px] text-gray-400">${d.date}</p></div>
                    </div>
                    <button onclick="deleteItem('dates', ${d.id})" class="text-gray-300 hover:text-red-500"><i class="ph ph-trash"></i></button>
                </div>
            `).join('');

            document.getElementById('media-gallery').innerHTML = filter(appData.media).map(m => `
                <div class="relative aspect-square rounded-xl overflow-hidden group bg-white/10">
                    <img onclick="openLightbox('${m.url}')" src="${m.url}" class="w-full h-full object-cover cursor-zoom-in">
                    <div class="absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t from-black/60 to-transparent flex justify-end">
                        <button onclick="deleteItem('media', ${m.id})" class="w-6 h-6 flex items-center justify-center rounded-full bg-white/20 backdrop-blur text-white hover:bg-red-500 transition">
                            <i class="ph ph-trash text-[12px]"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Start App
        initAuth();
    </script>
</body>
</html>
